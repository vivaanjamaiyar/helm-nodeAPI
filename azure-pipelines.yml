# Docker
# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- main

resources:
- repo: self

variables:
  # Container registry service connection established during pipeline creation
  dockerRegistryServiceConnection: '1c2945c6-be50-4332-a362-34103e6032c2'
  imageRepository: 'vivaanjamaiyarhelmnodeapi'
  containerRegistry: 'demoaz.azurecr.io'
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
  tag: '$(Build.BuildId)'

pool:
   name: 'azureagent'

stages:
- stage: Build
  displayName: Build stage
  jobs:
  - job: Build
    displayName: Build
    
    steps:
    - task: Docker@2
      displayName: Build an image to container registry
      inputs:
        containerRegistry: '$(dockerRegistryServiceConnection)'
        repository: '$(imageRepository)'
        command: 'build'
        Dockerfile: '**/Dockerfile'
        tags: '$(tag)'

- stage: Push
  displayName: Push stage
  jobs:
  - job: Push
    displayName: Push
    
    steps:
    - task: Docker@2
      displayName: Push an image to container registry
      inputs:
        containerRegistry: '$(dockerRegistryServiceConnection)'
        repository: '$(imageRepository)'
        command: 'push'
        tags: '$(tag)'


- stage: HelmInstallandDeploy
  displayName: HelmInstallandDeploy
  jobs:
  - job: HelmInstallandDeploy
    displayName: HelmInstallandDeploy
    steps:

    - task: HelmInstaller@1
      displayName: Install Helm
      inputs:
        helmVersionToInstall: '3.14.4'   # pin a stable v3 version

    - bash: |
        set -e
        helm version
        mkdir -p $(Build.ArtifactStagingDirectory)/charts

        # Package chart
        helm package helm --destination $(Build.ArtifactStagingDirectory)/charts
        ls -la $(Build.ArtifactStagingDirectory)/charts
      displayName: Package Helm chart

    # Login to Azure and ACR (uses your existing service connection)
    - task: AzureCLI@2
      displayName: Login to ACR
      inputs:
        azureSubscription: 'helm-connection'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          az acr login --name demoaz

    # Push packaged chart to ACR as OCI artifact
    - bash: |
        set -e
        CHART_TGZ=$(ls $(Build.ArtifactStagingDirectory)/charts/*.tgz | head -n 1)
        echo "Chart package: $CHART_TGZ"

        # Helm OCI push (modern method)
        helm registry login demoaz.azurecr.io
        helm push "$CHART_TGZ" oci://demoaz.azurecr.io/helm
      displayName: Push Helm chart to ACR (OCI)

- stage: HelmPublish
  displayName: Helm Publish
  jobs:
  - job: Publish
    displayName: Publish
    steps:
    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)/charts'
        artifact: 'helmapi'
        publishLocation: 'pipeline'
